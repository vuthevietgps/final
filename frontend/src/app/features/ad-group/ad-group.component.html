<div class="header-section">
  <div class="page-title">
    <h2><span class="icon">üì¢</span> Qu·∫£n L√Ω Nh√≥m Qu·∫£ng C√°o</h2>
  </div>
  <div class="header-actions">
    <button type="button" class="btn btn-primary" (click)="addNew()">‚ûï Th√™m Nh√≥m</button>
  </div>
</div>

<div *ngIf="error()" class="alert alert-danger">‚ö†Ô∏è {{ error() }}</div>
<div *ngIf="isLoading()" class="loading">ƒêang t·∫£i...</div>

<!-- Thanh t√¨m ki·∫øm v√† l·ªçc hi·ªán ƒë·∫°i -->
<div class="toolbar" *ngIf="!isLoading()">
  <div class="toolbar-left">
    <div class="search-input">
      <span class="prefix">üîé</span>
      <input type="text" [value]="searchQuery()" (input)="searchQuery.set($any($event.target).value)" placeholder="T√¨m t√™n ho·∫∑c ID nh√≥m qu·∫£ng c√°o...">
    </div>
    <button class="btn btn-primary" (click)="onSearch()">T√¨m</button>
    <button class="btn btn-ghost" (click)="resetFilters()">ƒê·∫∑t l·∫°i</button>
  </div>
  <div class="toolbar-right">
    <div class="pills">
      <select [value]="filterPlatform()" (change)="filterPlatform.set($any($event.target).value); onSearch()" class="pill">
        <option value="all">N·ªÅn t·∫£ng: T·∫•t c·∫£</option>
        <option value="facebook">N·ªÅn t·∫£ng: Facebook</option>
        <option value="google">N·ªÅn t·∫£ng: Google</option>
        <option value="ticktock">N·ªÅn t·∫£ng: Ticktock</option>
      </select>
      <select [value]="filterProductId()" (change)="filterProductId.set($any($event.target).value); onSearch()" class="pill">
        <option value="all">S·∫£n ph·∫©m: T·∫•t c·∫£</option>
        <option *ngFor="let p of products()" [value]="p._id">S·∫£n ph·∫©m: {{ p.name }}</option>
      </select>
      <select [value]="filterAgentId()" (change)="filterAgentId.set($any($event.target).value); onSearch()" class="pill">
        <option value="all">ƒê·∫°i l√Ω: T·∫•t c·∫£</option>
        <option *ngFor="let u of users()" [value]="u._id">ƒê·∫°i l√Ω: {{ u.fullName }}</option>
      </select>
      <select [value]="filterStatus()" (change)="filterStatus.set($any($event.target).value); onSearch()" class="pill">
        <option value="all">Tr·∫°ng th√°i: T·∫•t c·∫£</option>
        <option value="active">Tr·∫°ng th√°i: ƒêang ho·∫°t ƒë·ªông</option>
        <option value="inactive">Tr·∫°ng th√°i: ƒê√£ t·∫°m d·ª´ng</option>
      </select>
    </div>
  </div>
  
</div>

<div class="table-wrapper" *ngIf="!isLoading()">
  <table class="table">
    <thead>
      <tr>
        <th (click)="setSort('name')" class="sortable">T√™n Nh√≥m</th>
        <th (click)="setSort('createdAt')" class="sortable">ID Nh√≥m QC</th>
        <th (click)="setSort('platform')" class="sortable">N·ªÅn t·∫£ng</th>
        <th>S·∫£n ph·∫©m</th>
        <th>ƒê·∫°i l√Ω</th>
        <th>T√†i kho·∫£n QC</th>
        <th (click)="setSort('isActive')" class="sortable">Tr·∫°ng th√°i</th>
        <th>Ghi ch√∫</th>
        <th class="actions-col">H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let g of adGroups()" [class.editing-row]="isEditing(g._id!)">
        <!-- T√™n Nh√≥m -->
        <td>
          <div class="cell-with-avatar" *ngIf="!isEditing(g._id!)">
            <div class="avatar">{{ getInitials(g.name) }}</div>
            <div>
              <div class="cell-title">{{ g.name }}</div>
              <div class="cell-sub">T·∫°o: {{ g.createdAt | date:'dd/MM/yyyy HH:mm' }}</div>
            </div>
          </div>
          <input 
            *ngIf="isEditing(g._id!)" 
            type="text" 
            class="form-control-inline" 
            [value]="g.name" 
            (blur)="updateField(g, 'name', $any($event.target).value)"
            (keyup.enter)="updateField(g, 'name', $any($event.target).value)"
            placeholder="T√™n nh√≥m qu·∫£ng c√°o">
        </td>

        <!-- ID Nh√≥m QC -->
        <td>
          <code class="mono id-chip" *ngIf="!isEditing(g._id!)">{{ g.adGroupId }}</code>
          <input 
            *ngIf="isEditing(g._id!)" 
            type="text" 
            class="form-control-inline" 
            [value]="g.adGroupId" 
            (blur)="updateField(g, 'adGroupId', $any($event.target).value)"
            (keyup.enter)="updateField(g, 'adGroupId', $any($event.target).value)"
            placeholder="ID nh√≥m qu·∫£ng c√°o">
        </td>

        <!-- N·ªÅn t·∫£ng -->
        <td class="platform">
          <span *ngIf="!isEditing(g._id!)" class="pf-badge" [class.fb]="g.platform==='facebook'" [class.gg]="g.platform==='google'" [class.tt]="g.platform==='ticktock'">
            {{ g.platform }}
          </span>
          <select 
            *ngIf="isEditing(g._id!)" 
            class="form-control-inline" 
            [value]="g.platform" 
            (change)="updateField(g, 'platform', $any($event.target).value)">
            <option value="facebook">Facebook</option>
            <option value="google">Google</option>
            <option value="ticktock">Ticktock</option>
          </select>
        </td>

        <!-- S·∫£n ph·∫©m -->
        <td>
          <span *ngIf="!isEditing(g._id!)">{{ getProductName(g.productId) }}</span>
          <select 
            *ngIf="isEditing(g._id!)" 
            class="form-control-inline" 
            [value]="g.productId" 
            (change)="updateField(g, 'productId', $any($event.target).value)">
            <option value="" disabled>-- Ch·ªçn s·∫£n ph·∫©m --</option>
            <option *ngFor="let p of products()" [value]="p._id">{{ p.name }}</option>
          </select>
        </td>

        <!-- ƒê·∫°i l√Ω -->
        <td>
          <span *ngIf="!isEditing(g._id!)">{{ getUserName(g.agentId) }}</span>
          <select 
            *ngIf="isEditing(g._id!)" 
            class="form-control-inline" 
            [value]="g.agentId" 
            (change)="updateField(g, 'agentId', $any($event.target).value)">
            <option value="" disabled>-- Ch·ªçn ƒë·∫°i l√Ω --</option>
            <option *ngFor="let u of users()" [value]="u._id">{{ u.fullName }}</option>
          </select>
        </td>

        <!-- T√†i kho·∫£n QC -->
        <td>
          <span *ngIf="!isEditing(g._id!)">{{ getAdAccountName(g.adAccountId) }}</span>
          <select 
            *ngIf="isEditing(g._id!)" 
            class="form-control-inline" 
            [value]="g.adAccountId" 
            (change)="updateField(g, 'adAccountId', $any($event.target).value)">
            <option value="" disabled>-- Ch·ªçn t√†i kho·∫£n --</option>
            <option *ngFor="let acc of adAccounts()" [value]="acc._id">{{ acc.name }} ({{ acc.accountId }})</option>
          </select>
        </td>

        <!-- Tr·∫°ng th√°i -->
        <td>
          <span class="status" [class.active]="g.isActive" (click)="toggleActive(g)">
            {{ g.isActive ? 'ƒêang ho·∫°t ƒë·ªông' : 'ƒê√£ t·∫°m d·ª´ng' }}
          </span>
        </td>

        <!-- Ghi ch√∫ -->
        <td class="notes">
          <span *ngIf="!isEditing(g._id!)" [title]="g.notes || ''">{{ g.notes || '-' }}</span>
          <input 
            *ngIf="isEditing(g._id!)" 
            type="text" 
            class="form-control-inline" 
            [value]="g.notes || ''" 
            (blur)="updateField(g, 'notes', $any($event.target).value)"
            (keyup.enter)="updateField(g, 'notes', $any($event.target).value)"
            placeholder="Ghi ch√∫">
        </td>

        <!-- H√†nh ƒë·ªông -->
        <td class="row-actions">
          <div *ngIf="!isEditing(g._id!)">
            <button class="btn-icon" (click)="startEdit(g._id!)" title="Ch·ªânh s·ª≠a">‚úèÔ∏è</button>
            <button class="btn-icon danger" (click)="remove(g)" title="X√≥a">üóëÔ∏è</button>
          </div>
          <div *ngIf="isEditing(g._id!)" class="edit-actions">
            <button class="btn-icon success" (click)="saveEdit(g)" title="L∆∞u">‚úÖ</button>
            <button class="btn-icon secondary" (click)="cancelEdit(g._id!)" title="H·ªßy">‚ùå</button>
          </div>
        </td>
      </tr>
      <tr *ngIf="adGroups().length === 0">
        <td colspan="9" class="empty">Ch∆∞a c√≥ nh√≥m qu·∫£ng c√°o n√†o. Nh·∫•n "Th√™m Nh√≥m" ƒë·ªÉ th√™m m·ªõi.</td>
      </tr>
    </tbody>
  </table>
</div>
