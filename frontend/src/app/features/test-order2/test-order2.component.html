<div class="test-order2-page">
  <div class="toolbar">
    <div class="left">
      <button class="btn btn-primary" (click)="addNew()">‚ûï Th√™m m·ªõi</button>
      <button class="btn" (click)="refresh()">üîÑ L√†m m·ªõi</button>
      <button class="btn btn-success" (click)="downloadCSV()">üì• T·∫£i CSV</button>
    </div>
    <div class="filters-container">
      <!-- H√†ng 1: T√¨m ki·∫øm v√† c√°c b·ªô l·ªçc c∆° b·∫£n -->
      <div class="filter-row">
        <input class="input" type="text" placeholder="T√¨m KH/SƒêT/m√£ v·∫≠n ƒë∆°n" [ngModel]="q()" (ngModelChange)="q.set($event)" />
        <select class="select" [ngModel]="selectedProduct()" (ngModelChange)="selectedProduct.set($event)">
          <option value="all">S·∫£n ph·∫©m: T·∫•t c·∫£</option>
          <option *ngFor="let p of products()" [value]="p._id">{{ p.name }}</option>
        </select>
        <select class="select" [ngModel]="selectedAgent()" (ngModelChange)="selectedAgent.set($event)">
          <option value="all">ƒê·∫°i l√Ω: T·∫•t c·∫£</option>
          <option *ngFor="let a of agents()" [value]="a._id">{{ a.name }}</option>
        </select>
        <select class="select" [ngModel]="selectedAdGroup()" (ngModelChange)="selectedAdGroup.set($event)">
          <option value="all">ID Nh√≥m QC: T·∫•t c·∫£</option>
          <option *ngFor="let g of adGroups()" [value]="g._id">{{ g._id }}</option>
        </select>
      </div>

      <!-- H√†ng 2: Tr·∫°ng th√°i, ng√†y th√°ng v√† n√∫t t√¨m ki·∫øm -->
      <div class="filter-row">
        <select class="select status-select" [ngModel]="selectedProductionStatus()" (ngModelChange)="selectedProductionStatus.set($event)">
          <option value="all">TT S·∫£n xu·∫•t: T·∫•t c·∫£</option>
          <option *ngFor="let s of productionStatuses()" [value]="s" 
                  [ngStyle]="getStatusOptionStyle('prod', s)">{{ s }}</option>
        </select>
        <select class="select status-select" [ngModel]="selectedOrderStatus()" (ngModelChange)="selectedOrderStatus.set($event)">
          <option value="all">TT V·∫≠n ƒë∆°n: T·∫•t c·∫£</option>
          <option *ngFor="let s of orderStatuses()" [value]="s"
                  [ngStyle]="getStatusOptionStyle('del', s)">{{ s }}</option>
        </select>
        <select class="select" [ngModel]="selectedActive()" (ngModelChange)="selectedActive.set($event)">
          <option value="all">Tr·∫°ng th√°i: T·∫•t c·∫£</option>
          <option value="true">ƒêang ho·∫°t ƒë·ªông</option>
          <option value="false">Ng·ª´ng</option>
        </select>
        <input class="input date-input" type="date" [ngModel]="from()" (ngModelChange)="from.set($event)" title="T·ª´ ng√†y" />
        <input class="input date-input" type="date" [ngModel]="to()" (ngModelChange)="to.set($event)" title="ƒê·∫øn ng√†y" />
        <button class="btn btn-search" (click)="refresh()">üîç T√¨m ki·∫øm</button>
      </div>
    </div>
  </div>

  <div class="table-wrapper" *ngIf="!isLoading(); else loadingTpl">
    <table class="data-table" #tableEl>
      <thead>
        <tr>
          <th class="col-date sticky-col" #dateHeader>Ng√†y</th>
          <th class="col-customer sticky-col-2">KH</th>
          <th class="col-product">SP</th>
          <th class="col-qty">SL</th>
          <th class="col-agent">ƒê·∫°i l√Ω</th>
          <th class="col-wide">ID Nh√≥m QC</th>
          <th class="col-active">K√≠ch ho·∫°t</th>
          <th class="col-wide">Chi ti·∫øt DV</th>
          <th class="col-wide">TT S·∫£n xu·∫•t</th>
          <th class="w-order-status">TT V·∫≠n ƒë∆°n</th>
          <th class="col-wide">Link n·ªôp</th>
          <th class="col-wide">M√£ v·∫≠n ƒë∆°n</th>
          <th class="col-wide">ƒê·∫∑t c·ªçc</th>
          <th class="col-wide">COD</th>
          <th class="col-wider">Ng∆∞·ªùi nh·∫≠n</th>
          <th class="col-wide">SƒêT</th>
          <th class="col-wider">ƒê·ªãa ch·ªâ</th>
          <th class="center">X√≥a</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let o of filtered()">
          <td class="muted col-date sticky-col">{{ formatDate(o.createdAt) }}</td>
          <td class="col-customer sticky-col-2"><input type="text" [ngModel]="o.customerName" (blur)="onInputUpdate(o, 'customerName', $event)" /></td>
          <td class="col-product">
            <select [ngModel]="getId(o.productId)" (change)="onSelectUpdate(o, 'productId', $event)">
              <option *ngFor="let p of products()" [value]="p._id">{{ p.name }}</option>
            </select>
          </td>
          <td class="col-qty"><input class="input-qty" type="number" min="1" [ngModel]="o.quantity" (blur)="onInputUpdate(o, 'quantity', $event)" /></td>
          <td class="col-agent">
            <select [ngModel]="getId(o.agentId)" (change)="onSelectUpdate(o, 'agentId', $event)">
              <option *ngFor="let a of agents()" [value]="a._id">{{ a.name }}</option>
            </select>
          </td>
          <td>
            <select [ngModel]="o.adGroupId" (change)="onSelectUpdate(o, 'adGroupId', $event)">
              <option *ngFor="let g of adGroups()" [value]="g._id">{{ g.name }}</option>
            </select>
          </td>
          <td class="center col-active"><input type="checkbox" [ngModel]="o.isActive" (change)="onInputUpdate(o, 'isActive', $event)" /></td>
          <td><input type="text" [ngModel]="o.serviceDetails" (blur)="onInputUpdate(o, 'serviceDetails', $event)" /></td>
          <td [ngStyle]="statusCellStyle('prod', o.productionStatus)">
            <select [ngModel]="o.productionStatus" (change)="onSelectUpdate(o, 'productionStatus', $event)" [ngStyle]="statusSelectStyle('prod', o.productionStatus)" class="status-dropdown">
              <option *ngFor="let s of productionStatuses()" [value]="s" [ngStyle]="getStatusOptionStyle('prod', s)">{{ s }}</option>
            </select>
          </td>
          <td [ngStyle]="statusCellStyle('del', o.orderStatus || 'Ch∆∞a c√≥ m√£ v·∫≠n ƒë∆°n')">
            <select class="w-100 status-dropdown" [ngModel]="o.orderStatus || 'Ch∆∞a c√≥ m√£ v·∫≠n ƒë∆°n'" (change)="onSelectUpdate(o, 'orderStatus', $event)" [ngStyle]="statusSelectStyle('del', o.orderStatus || 'Ch∆∞a c√≥ m√£ v·∫≠n ƒë∆°n')">
              <option *ngFor="let s of orderStatuses()" [value]="s" [ngStyle]="getStatusOptionStyle('del', s)">{{ s }}</option>
            </select>
          </td>
          <td><input type="text" [ngModel]="o.submitLink" (blur)="onInputUpdate(o, 'submitLink', $event)" /></td>
          <td><input type="text" [ngModel]="o.trackingNumber" (blur)="onInputUpdate(o, 'trackingNumber', $event)" /></td>
          <td><input type="number" min="0" step="1000" [ngModel]="o.depositAmount" (blur)="onInputUpdate(o, 'depositAmount', $event)" /></td>
          <td><input type="number" min="0" step="1000" [ngModel]="o.codAmount" (blur)="onInputUpdate(o, 'codAmount', $event)" /></td>
          <td><input type="text" [ngModel]="o.receiverName" (blur)="onInputUpdate(o, 'receiverName', $event)" /></td>
          <td><input type="text" [ngModel]="o.receiverPhone" (blur)="onInputUpdate(o, 'receiverPhone', $event)" /></td>
          <td><input type="text" [ngModel]="o.receiverAddress" (blur)="onInputUpdate(o, 'receiverAddress', $event)" /></td>
          <td class="center"><button class="btn btn-sm btn-danger" (click)="delete(o)">X√≥a</button></td>
        </tr>
        <tr *ngIf="filtered().length===0">
          <td class="center muted" colspan="18">Ch∆∞a c√≥ ƒë∆°n</td>
        </tr>
      </tbody>
    </table>
  </div>

  <ng-template #loadingTpl>
    <div class="loading">ƒêang t·∫£i...</div>
  </ng-template>
</div>
